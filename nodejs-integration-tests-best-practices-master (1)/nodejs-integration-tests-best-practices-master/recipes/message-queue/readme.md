# Testing with message queues

## Intro

Sometimes the message queues are just on obstacle to overcome, for exmaple when one wishes to focus on the flow that starts with a message from a queue. In other cases, the MQ behaviour is the focus of the test like when trying to ensure that too much failures will put the message in a queue

There are three fundamentally different ways to approach this, by stubbing the message queue client or by using a real/fake message queue server in Docker:
|                                          	| Real Message Queue System                                                                       	| Stub The Client                                                                                                   	| Simplistic Fake Message Queue System                                                                                       	|
|------------------------------------------	|-------------------------------------------------------------------------------------------------	|-------------------------------------------------------------------------------------------------------------------	|----------------------------------------------------------------------------------------------------------------------------	|
| **Option description**                   	| Put real MQ in Docker: publish to real queues,  read from real queues                           	| No MQ system: Listen to the consume and publish methods  and assert they were called                              	| Fake MQ for testing: Expose an identical interface to the vendor library  with the same methods but without implementation 	|
| Confidence                               	| ☀️ <br/> (Test the driver and full flows including retry, dlq, etc)                              	| 🌦️❗️ <br/> (Part of our code is replaced. Harder to test error handling and interaction with the MQ library)        	| 🌥️ <br/> (Our real code is tested. Allows testing all signals to the MQ, but not a flow of a message among multiple queues) 	|
| Execution speed                          	| 🌦️❗️                                                                                              	| ☀️                                                                                                                 	| ☀️                                                                                                                          	|
| Flakiness                                	| 🌥️❗️ <br/> (For example, a test might assume a fresh queue but messages  were left from previous) 	| ☀️ <br/> (Nothing leaks between tests, very deterministic)                                                         	| ☀️ <br/> (Nothing leaks between tests, very deterministic)                                                                  	|
| Simplicity                               	| ☀️ <br/> (Just like production)                                                                  	| ☀️ <br/> (Stop before it even reaches to the rabbit hole)                                                          	| 🌥️ <br/> (Need to maintain a thing that behaves like MQ)                                                                    	|
| Winner                                   	| 🥈 <br/>  (Needed when testing deep MQ flows like dead-letter-queue, retries etc)                	| 🥈  <br/>   (Great when having confidence in the MQ lib and only wish to invoke a flow that starts with a message) 	| 🏆  <br/>   (The default and recommended approach: Great balance between simplicity and confidence)                         	|
|                                          	| Smaller details 👇                                                                               	| Smaller details 👇                                                                                                 	| Smaller details 👇                                                                                                          	|
| Discover a bug in the client lib         	| 👍🏼                                                                                              	| 😢                                                                                                                 	|                                                                                                                            	|
| Test that a message was tried to be sent 	| 👍🏼                                                                                              	| 👍🏼                                                                                                                	|                                                                                                                            	|
| Speed                                    	| 👍🏼                                                                                              	| 😐                                                                                                                 	|                                                                                                                            	|
| Test a flow that starts with a message   	| 👍🏼                                                                                              	| 👍🏼                                                                                                                	|                                                                                                                            	|
| Test arrival to dead-letter-queue        	| 😐                                                                                               	| 👍🏼                                                                                                                	|                                                                                                                            	|
| Test a poisoned message                  	| 👍🏼                                                                                              	| 👍🏼                                                                                                                	|                                                                                                                            	|